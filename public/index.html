<html>

<head>
    <title>.:Realtime:.</title>
    <script tye='text/javascript' src='https://code.jquery.com/jquery-3.4.1.js'></script>
    <script type='text/javascript' src='./js/moment.js'></script>
    <script type='text/javascript' src='./js/Chart.min.js'></script>
    <script type='text/javascript' src='./js/chartjs-plugin-streaming.js'></script>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.4"></script>
    <script type='text/javascript' src='./js/chartjs-plugin-annotation.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/chartjs-plugin-draggable@0.1.6/dist/chartjs-plugin-draggable.min.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.1.2'></script>
    
    <link rel='stylesheet' href='./js/Chart.min.css'></link>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

</head>

<body>

    <div class="panel panel-default md-col-12">
        <div class='panel-heading'>
            Realtime Measures
        </div>
        <div class="panel-body">
            <canvas id='realtime_measures' style='width:100%;height:350px'></canvas>
        </div>
    </div>

</body>
<script>
    var chart;
    var pwrDevices=[];
   
    $(document).ready(function () {
        let host = window.location.host;
        let ipAddress = host.split(":")[0];
        openWebSocket(ipAddress);
        initializeChart();
    })

    function onRefresh(chart, dataset, measures) {
            
            chart.options.scales.xAxes.realtime.delay = measures.Averaging * 1000
            chart.data.datasets[dataset].data.push({
                    x: measures.timestamp,
                    y: measures.Power
                })
            
        }
    function openWebSocket(ipAddress){
        var websocket = new WebSocket('ws://'+ipAddress+':8091');
        websocket.onopen = function(){
            console.log("Connected to websocket");
        }

        websocket.onerror = function (error){
            console.log("WebSocket error:" + error);
        }

        websocket.onmessage = function (message) {
            //console.log("Received: " + message.data);
            let rcvData = JSON.parse(message.data);
            if (rcvData.devices) {
                //console.log(rcvData.devices);
            }

            if (rcvData.measures0) { var datasetIdx = 0 ; var data = rcvData.measures0}
            if (rcvData.measures1) { var datasetIdx = 1 ; var data = rcvData.measures1}
            onRefresh(chart, datasetIdx, data);

        }

    }
    function initializeChart() {

        var ctx = document.getElementById('realtime_measures').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: '1',
                    borderColor:'rgb(204, 230, 255)',
                    borderWidth:1,
                    backgroundColor:'rgb(204, 230, 255, 0.5)',
                    pointRadius: 0,
                    data: []
                }, {
                    label: '2',
                    borderColor:'rgb(255, 238, 204)',
                    borderWidth:1,
                    backgroundColor:'rgb(255, 238, 204, 0.5)',
                    pointRadius: 0,
                    data: []
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        display: false,
                        gridLines:{
                            display:false
                        },
                        type: 'realtime',
                        realtime:{
                            //onRefresh: onRefresh,
                            duration:60000, //1 minute Window
                            refresh: 250,
                            delay :1000
                            
                        }
                    }],
                    yAxes:[{
                        gridLines:{
                            display:true
                        }
                    }]
                },
                tooltips:{
                    mode:'nearest',
                    intersect: false
                },
                hover:{
                    mode:'nearest',
                    intersect: false
                },
                plugins:{
                    streaming:{
                        frameRate:100
                    },
                    zoom:{
                        pan:{
                            enabled: false,
                            mode: 'xy',
                            rangeMin:{
                                x:null,
                                y:null
                            },
                            rangeMax:{
                                y:null,
                                x:null
                            }
                        },
                        zoom:{
                            enabled:true,
                            drag: true,
                            mode: 'x', //xy y x
                            rangeMin:{
                                x:null,
                                y:null
                            },
                            rangeMax:{
                                y:null,
                                x:null
                            },
                            speed:0.1
                        }
                    },
                    crosshair: false
                    
                }
            }
        });

    }

</script>
</html>
